FROM apache/spark:3.5.5-java17-python3

# Switch to root user to install packages
USER 0

ENV HIVE_VERSION=3.1.3

# Download and extract ONLY the Hive client JARs into our custom directory
RUN mkdir -p /opt/spark/hive-jars && \
    curl -fL "https://archive.apache.org/dist/hive/hive-${HIVE_VERSION}/apache-hive-${HIVE_VERSION}-bin.tar.gz" -o /tmp/hive.tar.gz && \
    tar -xzf /tmp/hive.tar.gz -C /tmp/ && \
    # Move the essential library files to our dedicated path
    mv /tmp/apache-hive-${HIVE_VERSION}-bin/lib/* /opt/spark/hive-jars/ && \
    # Clean up the system
    rm -rf /tmp/*

# Change ownership of the new directory
RUN chown -R spark:spark /opt/spark/hive-jars

# Switch back to the non-root spark user
USER spark